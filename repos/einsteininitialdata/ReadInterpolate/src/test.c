#include "cctk.h"
#include "cctk_Parameters.h"
#include "cctk_Arguments.h"

#include <math.h>

/********************************************************************
 ******************   Local Function prototypes  ********************
 ********************************************************************/

/* some polymial test data to used by the test cases */
static CCTK_REAL
test_data(const CCTK_REAL t, const CCTK_REAL x, const CCTK_REAL y,
          const CCTK_REAL z);

/********************************************************************
 *********************   Scheduled functions  ***********************
 ********************************************************************/

void ReadInterpolate_GenerateTestData(CCTK_ARGUMENTS)
{
  DECLARE_CCTK_ARGUMENTS;

  for(int k = 0 ; k < cctk_lsh[2] ; k++) {
    for(int j = 0 ; j < cctk_lsh[1] ; j++) {
      for(int i = 0 ; i < cctk_lsh[0] ; i++) {
        ptrdiff_t idx = CCTK_GFINDEX3D(cctkGH, i,j,k);
        test_values[idx] = test_data(cctk_time, x[idx], y[idx], z[idx]);
      }
    }
  }
}

// subtracts expected answer from read in values, should result in zero
// everywhere
void ReadInterpolate_CompareTestData(CCTK_ARGUMENTS)
{
  DECLARE_CCTK_PARAMETERS;
  DECLARE_CCTK_ARGUMENTS;

  for(int k = 0 ; k < cctk_lsh[2] ; k++) {
    for(int j = 0 ; j < cctk_lsh[1] ; j++) {
      for(int i = 0 ; i < cctk_lsh[0] ; i++) {
        ptrdiff_t idx = CCTK_GFINDEX3D(cctkGH, i,j,k);
        const CCTK_REAL x_shifted = x[idx] - shift_read_datasets_by[0];
        const CCTK_REAL y_shifted = y[idx] - shift_read_datasets_by[1];
        const CCTK_REAL z_shifted = z[idx] - shift_read_datasets_by[2];
        // compute squared difference on all timelevels
        const CCTK_REAL values[3] = {test_values[idx], test_values_p[idx],
                                     test_values_p_p[idx]};
        CCTK_REAL diff2 = 0.;
        for(int tl = 0 ; tl < 3 ; tl++) {
          const CCTK_REAL diff = values[tl] -
                                 test_data(cctk_time - tl*CCTK_DELTA_TIME,
                                           x_shifted, y_shifted, z_shifted);
          diff2 += diff*diff/(values[tl]*values[tl]);
        }
        test_results[idx] = sqrt(diff2);
      }
    }
  }
}

/********************************************************************
 ***********************   Local Functions  *************************
 ********************************************************************/

/* icc takes a very long time (>1hr) to compile this file when optimizing */
#ifdef __INTEL_COMPILER
#pragma GCC optimization_level 0
#endif
static CCTK_REAL
test_data(const CCTK_REAL t, const CCTK_REAL x, const CCTK_REAL y,
          const CCTK_REAL z)
{
  /* some arbirtraty coefficients c_ijk x^i y^j z^k t^l*/
  const CCTK_REAL coeffs[4][4][4][3] = {
    {{{-0.879505163842616, -0.796902433322487, 0.550002349151576},
      {-0.0187197102296608, -0.794978846073569, 0.207426326320245},
      {0.0212754279315774, -0.912216807167923, -0.211686218174854},
      {0.167946043542088, -0.84595616624248, 0.202178332004181}},
     {{-0.415261113490509, 0.870391930616762, 0.63378464910874},
      {-0.653550150629385, 0.939167930687866, 0.222250566117566},
      {0.153282295574989, -0.899450752736797, -0.331666159309144},
      {0.499521636034018, -0.939591142742479, 0.484154214115094}},
     {{-0.077263379614628, 0.714457583261378, 0.70767891193119},
      {0.432053264036838, -0.284887851841994, 0.683596827847083},
      {0.130187241702167, 0.739396443563564, -0.973225170272364},
      {-0.0236340017898442, -0.305127671412698, 0.910860281385013}},
     {{0.934677067144925, -0.517360288305809, -0.10240501180494},
      {0.719181712045994, 0.10331176849656, 0.136115986271534},
      {-0.595579518495619, 0.199849017593081, 0.516383988554686},
      {-0.316355521014174, 0.0151345956166935, 0.297576026944157}}},
    {{{-0.600490117102815, 0.144436555802088, 0.652050124297737},
      {-0.764642983629287, 0.979331101872084, 0.634343826928074},
      {0.33346053312976, 0.978482090908571, 0.764876171189549},
      {0.94731835637765, 0.872812987161034, 0.77521442075097}},
     {{0.308522927897549, -0.871783600433531, 0.652193976068581},
      {-0.184530316271221, -0.552466670967526, 0.208981363062264},
      {0.058688118041367, -0.517377450154171, -0.459890449666396},
      {-0.68410615874339, 0.25747498384515, 0.686573161513181}},
     {{-0.454226130929491, 0.0222101906820171, 0.0253105818465755},
      {-0.6552335613856, 0.46837000325511, -0.317420721032221},
      {-0.0923098918469876, 0.489546795834698, -0.152864015704715},
      {-0.361167082989994, 0.424147318466019, -0.226121374199906}},
     {{-0.0306261035054476, 0.758042174825817, -0.733295955249737},
      {-0.346853199501496, -0.734244450287456, 0.411322418768691},
      {0.16058158538609, 0.349799600192981, -0.928979014026389},
      {0.415207615301512, -0.565685432897119, 0.252587018588073}}},
    {{{0.379764281846072, -0.142797650644127, -0.564991964318303},
      {-0.163091559626409, 0.346424021012275, 0.365311228450736},
      {-0.813459394830325, 0.972393367445804, -0.325980299390203},
      {0.041143012200564, -0.506818892835021, -0.155374691905578}},
     {{0.467365825646745, -0.227955954387397, 0.813743957610079},
      {0.177460264244459, 0.00946816307931186, 0.315335508654982},
      {0.353700023472491, -0.700484419544622, -0.17317280401263},
      {-0.215935251028128, -0.967524249303956, 0.43319037980568}},
     {{0.568957863694045, -0.133064335671065, -0.725345667127876},
      {0.758353531029414, 0.0243478206478827, 0.224709871391866},
      {0.347329382209288, -0.0418228066781836, 0.0703343204213596},
      {-0.507927637227169, 0.528094535570993, -0.484668404905378}},
     {{0.705248056277163, 0.679685639924145, 0.451972313605147},
      {0.69796794563733, 0.391166491413806, 0.549118040415578},
      {0.170132975305556, -0.557070620870988, -0.245494984775199},
      {0.787978279401187, -0.216080301275731, 0.976022713746019}}},
    {{{-0.0845327083092045, 0.139622221663615, -0.0738792040047898},
      {-0.445215300275763, -0.831657952628312, 0.668172717518331},
      {0.185503462333422, -0.991936545839692, 0.891287904375936},
      {-0.776487901932683, 0.054487389240613, 0.390237062074519}},
     {{-0.938643676843093, 0.10182275781122, 0.773881066776646},
      {-0.0414150121911376, 0.879080906021279, 0.59586728046105},
      {0.10946938344798, -0.505957886802989, 0.214274849832158},
      {0.34746891193501, 0.585818830018006, -0.326621975881224}},
     {{0.974242850549736, 0.435778977983091, 0.892096850360609},
      {0.501083730039866, -0.672805122025032, -0.726646792348419},
      {-0.661624716642798, 0.73949244693857, 0.903262581346901},
      {0.483506982881693, 0.560445029778883, 0.634738527634241}},
     {{0.715430280291947, 0.87383341393101, -0.265499317900726},
      {-0.895852790041729, -0.678582833966452, -0.189649034986473},
      {0.864300498249996, 0.7888756974465, -0.430148890256667},
      {0.173952249573546, -0.857040592540336, 0.126671314282802}}},
  };

  CCTK_REAL retval = 0;
  for(int i = 0 ; i < 4 ; i++) {
    for(int j = 0 ; j < 4 ; j++) {
      for(int k = 0 ; k < 4 ; k++) {
        for(int l = 0 ; l < 3 ; l++) {
          retval += coeffs[i][j][k][l] * pow(x, i) * pow(y, j) * pow(z, k) * pow(t, l);
        }
      }
    }
  }

  return  retval;
}
